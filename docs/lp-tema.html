<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>LLPC • Tema</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#071617;--card:#0c1f20;--muted:#9ad2ca;--text:#dff6f2;--pill:#093c3a;
    --accent:#19b3a4;--accent-2:#2dd4bf;--chip:#083f3d;--danger:#f87171
  }
  *{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  a{color:inherit;text-decoration:none}
  .wrap{max-width:1200px;margin:0 auto;padding:24px}
  .back{display:inline-flex;gap:10px;align-items:center;background:var(--chip);color:var(--accent-2);padding:10px 14px;border-radius:999px}
  h1{margin:18px 0 8px;font-size:34px;letter-spacing:.3px}
  .tabs{display:flex;flex-wrap:wrap;gap:10px;margin:14px 0 8px}
  .tab{background:var(--pill);padding:8px 14px;border-radius:999px;color:var(--muted);cursor:pointer;border:1px solid transparent}
  .tab.active{background:#0e2d2c;color:#c8fff7;border-color:#114a47}
  .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:18px;margin-top:18px}
  @media (max-width:1100px){.grid{grid-template-columns:repeat(8,1fr)}}
  @media (max-width:720px){.grid{grid-template-columns:repeat(4,1fr)}}
  .card{grid-column:span 4;background:var(--card);border-radius:18px;padding:14px 14px 12px;border:1px solid #123332;box-shadow:0 0 0 1px #0b2221 inset}
  @media (max-width:720px){.card{grid-column:span 4}}
  .title{font-weight:700;margin:6px 0 10px;line-height:1.25}
  .badge{position:absolute;top:10px;right:10px;background:#0d2b2a;color:#aefcf3;padding:10px 12px;border-radius:999px;font-weight:700;font-size:13px;border:1px solid #134543}
  .slider{position:relative;border-radius:14px;overflow:hidden;background:#061111;height:260px}
  .slider .track{display:flex;height:100%;transition:transform .25s ease-out}
  .slider img{height:100%;width:auto;object-fit:cover;flex:0 0 100%}
  .nav{position:absolute;top:50%;transform:translateY(-50%);display:flex;justify-content:space-between;width:100%;padding:0 6px;pointer-events:none}
  .nav button{pointer-events:auto;border:0;border-radius:999px;height:36px;width:36px;background:#0b2322;color:#bffaf3;font-weight:700}
  .prog{height:6px;background:#0b2322;border-radius:999px;margin:10px 0 0;overflow:hidden}
  .prog > i{display:block;height:100%;background:linear-gradient(90deg,#14b8a6,#2dd4bf);width:0%}
  .row{display:flex;justify-content:space-between;align-items:center;margin-top:10px;gap:10px}
  .price{display:flex;flex-direction:column;gap:2px}
  .de{font-size:13px;color:#9bcac4;text-decoration:line-through}
  .por{font-size:18px;color:#b7fff6;font-weight:800}
  .cta{background:#0b2d2b;border:1px solid #134543;color:#aefcf3;padding:10px 14px;border-radius:999px;font-weight:700}
  .err{background:#2f1616;border:1px solid #6c1b1b;color:#ffd9d9;padding:10px 12px;border-radius:12px;margin:16px 0;display:inline-block}
  .muted{color:#9ad2ca;margin-top:24px}
</style>
</head>
<body>
  <div class="wrap" id="root">
    <a class="back" href="./">← Temas</a>
    <h1 id="tema-h1">Tema</h1>
    <div class="tabs" id="tabs" hidden></div>
    <div id="error" class="err" hidden>Erro ao carregar dados.</div>
    <div class="grid" id="grid"></div>
    <p class="muted">LLPC • Laços & Letras Papelaria Criativa</p>
  </div>

<script>
(async function(){
  const $ = sel => document.querySelector(sel);
  const params = new URLSearchParams(location.search);
  const raw = params.get('tema') || params.get('slug') || '';
  if(!raw){ return showError('Tema ausente na URL.'); }

  const slug = toSlug(raw);
  $('#tema-h1').textContent = humanize(slug);

  try{
    // Busca JSON do tema + precos.json (ambos relativos à pasta docs/)
    const [temaRes, precRes] = await Promise.all([
      fetch('catalogo/'+slug+'.json', {cache:'no-store'}),
      fetch('precos.json', {cache:'no-store'})
    ]);
    if(!temaRes.ok){ throw new Error('Tema não encontrado: '+slug); }

    const tema = await temaRes.json();
    const precosArr = precRes.ok ? await precRes.json() : [];

    // Mapa de preços por SKU (case-insensitive)
    const pm = new Map();
    for(const p of (precosArr||[])){
      const k = (p.sku||p.SKU||'').trim().toUpperCase();
      if(k) pm.set(k, p);
    }

    // Normaliza cards (estrutura tolerante a diferentes chaves)
    const origCards = tema.cards || tema.itens || tema.items || tema;
    if(!Array.isArray(origCards) || !origCards.length){
      return showError('Tema sem itens.');
    }

    const cards = origCards.map(c=>{
      const imgs = Array.isArray(c.imgs||c.imagens||c.fotos) ? (c.imgs||c.imagens||c.fotos) : [];
      const firstImg = imgs[0] || c.img || c.imagem || '';
      const folder = c.folder || c.pasta || c.dir || guessFolder(firstImg);
      const title = c.title || c.titulo || c.nome || folder || 'Item';
      const sku = (c.sku||c.SKU||c.codigo||'').trim().toUpperCase();
      const grupo = normGrupo(c.grupo||c.kit||c.linha||c.categoria||guessGrupoFromPath(firstImg||folder));
      return {title, imgs, sku, grupo};
    });

    // Grupos → abas
    const groups = ['todos','essencial','classico','premium','luxo'];
    renderTabs(groups, (g)=> renderGrid(cards, pm, g));
    // Inicial: "todos"
    renderGrid(cards, pm, 'todos');

  }catch(err){
    showError(err.message||String(err));
  }

  // ---------- helpers ----------
  function showError(msg){
    const el = $('#error');
    el.textContent = msg || 'Erro ao carregar dados.';
    el.hidden = false;
  }

  function toSlug(s){
    return (s||'')
      .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
      .toLowerCase()
      .replace(/&/g,' e ')
      .replace(/[^a-z0-9]+/g,'-')
      .replace(/^-+|-+$/g,'');
  }
  function humanize(slug){
    return slug.split('-').map(w=> w? w[0].toUpperCase()+w.slice(1):w).join(' ');
  }
  function normGrupo(s=''){
    const x = s.toLowerCase();
    if(x.includes('essencial')) return 'essencial';
    if(x.includes('classico')||x.includes('clássico')) return 'classico';
    if(x.includes('premium')) return 'premium';
    if(x.includes('luxo')) return 'luxo';
    return 'todos';
  }
  function guessFolder(url){
    if(!url) return '';
    try{
      const dec = decodeURIComponent(url);
      const parts = dec.split('/');
      // último diretório antes do arquivo
      return parts.length>1 ? parts[parts.length-2] : '';
    }catch{ return '' }
  }
  function guessGrupoFromPath(s=''){
    const x = s.toLowerCase();
    if(x.includes('essencial')) return 'essencial';
    if(x.includes('classico')||x.includes('clássico')) return 'classico';
    if(x.includes('premium')) return 'premium';
    if(x.includes('luxo')) return 'luxo';
    return 'todos';
  }

  function renderTabs(list, onClick){
    const tabs = $('#tabs');
    tabs.innerHTML = '';
    tabs.hidden = false;
    list.forEach((g,idx)=>{
      const btn = document.createElement('button');
      btn.className = 'tab'+(idx===0?' active':'');
      btn.dataset.g = g;
      btn.textContent = g[0].toUpperCase()+g.slice(1);
      btn.onclick = ()=>{
        tabs.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
        btn.classList.add('active');
        onClick(g);
      };
      tabs.appendChild(btn);
    });
  }

  function renderGrid(allCards, pm, activeGroup){
    const grid = $('#grid');
    grid.innerHTML = '';
    const cards = activeGroup==='todos' ? allCards : allCards.filter(c=>c.grupo===activeGroup);

    for(const c of cards){
      const card = document.createElement('div');
      card.className = 'card';

      // badge de preço
      let priceHtml = `<span class="badge">Preço sob consulta</span>`;
      const price = c.sku && pm.get(c.sku);
      if(price){
        const de = toBRL(price.preco_de ?? price.precoDe ?? null);
        const por = toBRL(price.preco_por ?? price.precoPor ?? null);
        if(por){
          priceHtml = `<span class="badge">${de ? `de ${de}<br>`:''}por ${por}</span>`;
        }
      }

      const imgs = (c.imgs && c.imgs.length) ? c.imgs : [];
      const slider = renderSlider(imgs);

      card.innerHTML = `
        <div style="position:relative">${priceHtml}${slider.outer}</div>
        ${slider.prog}
        <div class="title">${escapeHtml(c.title||'Item')}</div>
        <div class="row">
          <div class="price">
            ${price? (price.preco_de? `<div class="de">${toBRL(price.preco_de)}</div>`:'') : ''}
            ${price? (price.preco_por? `<div class="por">${toBRL(price.preco_por)}</div>`:'') : ''}
          </div>
          <a class="cta" target="_blank"
             href="https://wa.me/5519999999999?text=${encodeURIComponent(`Olá! Quero este item (${c.title}) do tema ${$('#tema-h1').textContent}. SKU: ${c.sku||'-'}`)}">
            Pedir no WhatsApp
          </a>
        </div>
      `;
      // ativa controles do slider
      slider.bind(card);
      grid.appendChild(card);
    }
  }

  function renderSlider(imgs){
    const htmlImgs = (imgs.length? imgs: ['https://dummyimage.com/800x600/0b2322/9ad2ca&text=Sem+imagem'])
      .map(u=> `<img loading="lazy" src="${escapeHtml(u)}" alt="">`).join('');
    const outer = `
      <div class="slider" data-n="${imgs.length||1}">
        <div class="track">${htmlImgs}</div>
        <div class="nav">
          <button type="button" data-dir="-1">‹</button>
          <button type="button" data-dir="1">›</button>
        </div>
      </div>`;
    const prog = `<div class="prog"><i></i></div>`;
    function bind(root){
      const slider = root.querySelector('.slider');
      const track = root.querySelector('.track');
      const prog = root.querySelector('.prog > i');
      let idx = 0, n = Number(slider.dataset.n)||1;
      const set = (i)=>{
        idx = ((i%n)+n)%n;
        const pct = n>1 ? ((idx+1)/n)*100 : 0;
        track.style.transform = `translateX(${-idx*100}%)`;
        prog.style.width = pct+'%';
      };
      slider.querySelectorAll('button[data-dir]').forEach(b=>{
        b.addEventListener('click', ()=> set(idx + Number(b.dataset.dir)));
      });
      set(0);
    }
    return {outer, prog, bind};
  }

  function toBRL(v){
    const num = Number(v);
    if(!isFinite(num)) return '';
    return num.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
  }
  function escapeHtml(s=''){
    return s.replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
  }
})();
</script>
</body>
</html>
